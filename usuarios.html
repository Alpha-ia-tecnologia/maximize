<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Usu√°rios - SAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="js/pagination.js"></script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="min-h-screen flex flex-col">
      <!-- Navbar -->
      <nav class="bg-blue-600 text-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between h-16">
            <div class="flex items-center">
              <div class="flex-shrink-0 flex items-center">
                <span class="text-xl font-bold">SAG</span>
              </div>
              <div class="hidden md:ml-6 md:flex md:items-center md:space-x-4">
                <a
                  href="dashboard.html"
                  class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700"
                  >Dashboard</a
                >
                <a
                  href="escolas.html"
                  class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700"
                  >Escolas</a
                >
                <a
                  href="turmas.html"
                  class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700"
                  >Turmas</a
                >
                <a
                  href="alunos.html"
                  class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700"
                  >Alunos</a
                >
                <a
                  href="provas.html"
                  class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700"
                  >Provas</a
                >
                <a
                  href="usuarios.html"
                  class="px-3 py-2 rounded-md text-sm font-medium bg-blue-700"
                  >Usu√°rios</a
                >
                <a
                  href="gabaritos_geracao.html"
                  class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700"
                  >Gabaritos</a
                >
              </div>
            </div>
            <div class="flex items-center">
              <span id="userNameDisplay" class="mr-4"></span>
              <button
                id="logoutBtn"
                class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700"
              >
                <i class="fas fa-sign-out-alt mr-1"></i> Sair
              </button>
            </div>
          </div>
        </div>

        <!-- Mobile menu -->
        <div class="md:hidden hidden" id="mobileMenu">
          <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            <a
              href="dashboard.html"
              class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700"
              >Dashboard</a
            >
            <a
              href="escolas.html"
              class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700"
              >Escolas</a
            >
            <a
              href="turmas.html"
              class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700"
              >Turmas</a
            >
            <a
              href="alunos.html"
              class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700"
              >Alunos</a
            >
            <a
              href="provas.html"
              class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700"
              >Provas</a
            >
            <a
              href="usuarios.html"
              class="block px-3 py-2 rounded-md text-base font-medium bg-blue-700"
              >Usu√°rios</a
            >
            <a
              href="gabaritos_geracao.html"
              class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700"
              >Gabaritos</a
            >
            <a
              href="gabaritos_correcao.html"
              class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700"
              >Corre√ß√£o</a
            >
          </div>
        </div>
      </nav>

      <!-- Main content -->
      <main class="flex-grow">
        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
          <!-- Page header -->
          <div
            class="px-4 py-5 sm:px-6 bg-white shadow rounded-lg mb-6 flex justify-between items-center"
          >
            <div>
              <h1 class="text-2xl font-bold text-gray-900">Usu√°rios</h1>
              <p class="mt-1 max-w-2xl text-sm text-gray-500">
                Gerenciamento de usu√°rios do sistema
              </p>
            </div>
            <button
              id="addUserBtn"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              <i class="fas fa-plus mr-2"></i> Novo Usu√°rio
            </button>
          </div>

          <!-- Debug: Bot√£o para limpar dados (s√≥ aparece em caso de problema) -->
          <div
            id="debugSection"
            class="mb-4 p-2 bg-gray-100 border rounded text-xs"
            style="display: none"
          >
            <span class="text-gray-600">Debug: </span>
            <button
              id="clearSessionBtn"
              class="text-red-600 underline hover:text-red-800"
            >
              Limpar dados de sess√£o
            </button>
            <span class="text-gray-500"
              >| Use se houver problemas de cache</span
            >
          </div>

          <!-- Bot√£o tempor√°rio para for√ßar corre√ß√£o de dados -->
          <div
            id="adminFixButton"
            class="mb-4 p-4 bg-yellow-100 border border-yellow-400 rounded-lg"
            style="display: none"
          >
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-yellow-800 font-semibold">
                  Dados de Usu√°rio Inconsistentes Detectados
                </h3>
                <p class="text-yellow-700">
                  Seu email indica que voc√™ √© administrador, mas o sistema n√£o
                  est√° reconhecendo corretamente.
                </p>
              </div>
              <button
                id="fixUserDataBtn"
                class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600"
              >
                Corrigir Agora
              </button>
            </div>
          </div>

          <!-- Users List -->
          <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <ul id="usersList" class="divide-y divide-gray-200 overflow-hidden">
              <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin mr-2"></i> Carregando
                usu√°rios...
              </li>
            </ul>
          </div>

          <!-- Pagination Controls -->
          <div
            id="usersPaginationControls"
            class="px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 hidden"
          >
            <div class="flex-1 flex justify-between sm:hidden">
              <button
                id="usersPrevPageMobile"
                class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
              >
                Anterior
              </button>
              <div class="text-sm text-gray-700 py-2">
                <span id="usersCurrentPageMobile">1</span>
              </div>
              <button
                id="usersNextPageMobile"
                class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
              >
                Pr√≥xima
              </button>
            </div>
            <div
              class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between"
            >
              <div>
                <p class="text-sm text-gray-700">
                  Mostrando
                  <span id="usersStartItem" class="font-medium">1</span> a
                  <span id="usersEndItem" class="font-medium">10</span> de
                  <span id="usersTotalItems" class="font-medium">0</span>
                  usu√°rios
                </p>
              </div>
              <div>
                <nav
                  class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px"
                  aria-label="Pagination"
                >
                  <button
                    id="usersPrevPage"
                    class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                  >
                    <span class="sr-only">Anterior</span>
                    <i class="fas fa-chevron-left"></i>
                  </button>
                  <div id="usersPaginationContainer" class="flex">
                    <!-- Page buttons will be inserted here -->
                  </div>
                  <button
                    id="usersNextPage"
                    class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                  >
                    <span class="sr-only">Pr√≥xima</span>
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="bg-white">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
          <p class="text-center text-sm text-gray-500">
            SAG - Sistema de Avalia√ß√£o e Gerenciamento ¬© 2023
          </p>
        </div>
      </footer>

      <!-- Add User Modal -->
      <div
        id="addUserModal"
        class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden"
      >
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">
              Adicionar Novo Usu√°rio
            </h3>
            <button
              id="closeUserModal"
              class="text-gray-400 hover:text-gray-500"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          <form id="addUserForm" class="space-y-4">
            <div>
              <label
                for="userName"
                class="block text-sm font-medium text-gray-700"
                >Nome</label
              >
              <input
                type="text"
                id="userName"
                name="userName"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <label
                for="userEmail"
                class="block text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                type="email"
                id="userEmail"
                name="userEmail"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <label
                for="userPassword"
                class="block text-sm font-medium text-gray-700"
                >Senha</label
              >
              <input
                type="password"
                id="userPassword"
                name="userPassword"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <label
                for="userType"
                class="block text-sm font-medium text-gray-700"
                >Tipo de Usu√°rio</label
              >
              <select
                id="userType"
                name="userType"
                required
                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
              >
                <option value="">Selecione o tipo</option>
                <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                <option value="COORDENADOR">COORDENADOR</option>
                <option value="PROFESSOR">PROFESSOR</option>
                <option value="GESTOR">GESTOR</option>
                <option value="SECRETARIA">SECRETARIA</option>
              </select>
            </div>
            <div class="flex justify-end">
              <button
                type="button"
                id="cancelUserBtn"
                class="mr-3 bg-gray-200 px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
              >
                Cancelar
              </button>
              <button
                type="submit"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                Salvar
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Edit User Modal -->
      <div
        id="editUserModal"
        class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden"
      >
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">Editar Usu√°rio</h3>
            <button
              id="closeEditUserModal"
              class="text-gray-400 hover:text-gray-500"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          <form id="editUserForm" class="space-y-4">
            <input type="hidden" id="editUserId" />
            <input type="hidden" id="editUserApiId" />
            <div>
              <label
                for="editUserName"
                class="block text-sm font-medium text-gray-700"
                >Nome</label
              >
              <input
                type="text"
                id="editUserName"
                name="editUserName"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <label
                for="editUserEmail"
                class="block text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                type="email"
                id="editUserEmail"
                name="editUserEmail"
                required
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <label
                for="editUserPassword"
                class="block text-sm font-medium text-gray-700"
                >Nova Senha (deixe em branco para manter a atual)</label
              >
              <input
                type="password"
                id="editUserPassword"
                name="editUserPassword"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div>
              <label
                for="editUserType"
                class="block text-sm font-medium text-gray-700"
                >Tipo de Usu√°rio</label
              >
              <select
                id="editUserType"
                name="editUserType"
                required
                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
              >
                <option value="">Selecione o tipo</option>
                <option value="ADMINISTRADOR">ADMINISTRADOR</option>
                <option value="COORDENADOR">COORDENADOR</option>
                <option value="PROFESSOR">PROFESSOR</option>
                <option value="GESTOR">GESTOR</option>
                <option value="SECRETARIA">SECRETARIA</option>
              </select>
            </div>
            <div class="flex justify-end">
              <button
                type="button"
                id="cancelEditUserBtn"
                class="mr-3 bg-gray-200 px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
              >
                Cancelar
              </button>
              <button
                type="submit"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                Atualizar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="js/app.js"></script>
    <script src="js/alert.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Inicializar lista de usu√°rios se n√£o existir
        if (!localStorage.getItem("users")) {
          localStorage.setItem("users", JSON.stringify([]));
        }

        // Verificar se o usu√°rio atual √© administrador
        console.log(
          "üîß Usuario.html: Iniciando valida√ß√£o dos dados do usu√°rio..."
        );
        let currentUser = validateAndFixUserData();
        console.log(
          "üîç Usuario.html: currentUser completo (ap√≥s valida√ß√£o):",
          currentUser
        );

        if (currentUser) {
          document.getElementById("userNameDisplay").textContent =
            currentUser.name;

          console.log(
            "üîç Usuario.html: Tipo do usu√°rio (type):",
            currentUser.type
          );
          console.log(
            "üîç Usuario.html: Role do usu√°rio (role):",
            currentUser.role
          );
          console.log(
            "üîç Usuario.html: Tipo original da API (originalType):",
            currentUser.originalType
          );

          // Verificar se h√° inconsist√™ncias nos dados
          const knownAdminEmails = [
            "sag@gmail.com",
            "admin@sag.com",
            "maximiza@gmail.com",
            "luiz@maximiza.com",
            "drive@sag.com",
          ];
          const shouldBeAdmin = knownAdminEmails.includes(currentUser.email);
          const isCurrentlyAdmin = currentUser.type === "ADMINISTRADOR";

          // Mostrar bot√£o de corre√ß√£o se necess√°rio
          if (shouldBeAdmin && !isCurrentlyAdmin) {
            console.log(
              "‚ö†Ô∏è Usuario.html: Inconsist√™ncia detectada - mostrando bot√£o de corre√ß√£o"
            );
            document.getElementById("adminFixButton").style.display = "block";
            document.getElementById("debugSection").style.display = "block";
          }

          // Usar a fun√ß√£o isAdmin do app.js para verificar se √© administrador
          const isAdminUser = isAdmin(currentUser);
          console.log(
            "‚úÖ Usuario.html: Resultado da verifica√ß√£o de administrador:",
            isAdminUser
          );

          // Se n√£o for admin, redirecionar para dashboard
          if (!isAdminUser) {
            console.log(
              "‚ùå Usuario.html: Usu√°rio n√£o √© administrador, redirecionando..."
            );
            showAlert(
              "warning",
              "Acesso Restrito",
              "Apenas administradores podem acessar esta p√°gina.",
              3000,
              function () {
                window.location.href = "dashboard.html";
              }
            );
            return; // Impedir a execu√ß√£o do resto do c√≥digo
          } else {
            console.log(
              "‚úÖ Usuario.html: Usu√°rio √© administrador, acesso liberado!"
            );
          }
        } else {
          console.log(
            "‚ùå Usuario.html: currentUser n√£o encontrado no sessionStorage"
          );
        }

        // Evento para o bot√£o de corre√ß√£o
        const fixUserDataBtn = document.getElementById("fixUserDataBtn");
        if (fixUserDataBtn) {
          fixUserDataBtn.addEventListener("click", function () {
            console.log("üîß Usuario.html: For√ßando corre√ß√£o dos dados...");

            const currentUser = JSON.parse(
              sessionStorage.getItem("currentUser")
            );
            if (currentUser) {
              // For√ßar corre√ß√£o para administrador
              currentUser.type = "ADMINISTRADOR";
              currentUser.role = "ADMINISTRADOR";
              currentUser.originalType = "ADMINISTRADOR";

              sessionStorage.setItem(
                "currentUser",
                JSON.stringify(currentUser)
              );
              console.log("‚úÖ Usuario.html: Dados corrigidos manualmente");

              // Esconder o bot√£o e recarregar a p√°gina
              document.getElementById("adminFixButton").style.display = "none";
              showAlert(
                "success",
                "Dados Corrigidos",
                "Os dados foram corrigidos. Recarregando a p√°gina...",
                2000,
                function () {
                  window.location.reload();
                }
              );
            }
          });
        }

        // Evento para o bot√£o de debug (limpar sess√£o)
        const clearSessionBtn = document.getElementById("clearSessionBtn");
        if (clearSessionBtn) {
          clearSessionBtn.addEventListener("click", function () {
            console.log("üóëÔ∏è Usuario.html: Limpando sessionStorage...");
            sessionStorage.clear();
            showAlert(
              "info",
              "Sess√£o Limpa",
              "Os dados de sess√£o foram limpos. Redirecionando para login...",
              2000,
              function () {
                window.location.href = "index.html";
              }
            );
          });
        }

        // Carregar usu√°rios da API
        loadUsersFromAPI();

        // Eventos dos modais
        const addUserBtn = document.getElementById("addUserBtn");
        const addUserModal = document.getElementById("addUserModal");
        const closeUserModal = document.getElementById("closeUserModal");
        const cancelUserBtn = document.getElementById("cancelUserBtn");
        const addUserForm = document.getElementById("addUserForm");

        // Configurar eventos para modal de edi√ß√£o
        const editUserModal = document.getElementById("editUserModal");
        const closeEditUserModal =
          document.getElementById("closeEditUserModal");
        const cancelEditUserBtn = document.getElementById("cancelEditUserBtn");
        const editUserForm = document.getElementById("editUserForm");

        // Configurar eventos para fechar o modal de edi√ß√£o
        if (closeEditUserModal) {
          closeEditUserModal.addEventListener("click", function () {
            editUserModal.classList.add("hidden");
          });
        }

        if (cancelEditUserBtn) {
          cancelEditUserBtn.addEventListener("click", function () {
            editUserModal.classList.add("hidden");
          });
        }

        // Configurar evento de envio do formul√°rio de edi√ß√£o
        if (editUserForm) {
          editUserForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const userId = document.getElementById("editUserId").value;
            const apiId = document.getElementById("editUserApiId").value;
            const name = document.getElementById("editUserName").value;
            const email = document.getElementById("editUserEmail").value;
            const password = document.getElementById("editUserPassword").value;
            const type = document.getElementById("editUserType").value;

            if (
              name &&
              name.trim() !== "" &&
              email &&
              email.trim() !== "" &&
              type
            ) {
              try {
                updateUserAPI(userId, apiId, name, email, password, type);
              } catch (error) {
                console.error("Erro ao atualizar usu√°rio:", error);
                showAlert(
                  "error",
                  "Erro",
                  "Ocorreu um erro ao atualizar o usu√°rio: " + error.message
                );
              }
            } else {
              showAlert(
                "error",
                "Erro",
                "Por favor, preencha todos os campos obrigat√≥rios."
              );
            }
          });
        }

        addUserBtn.addEventListener("click", function () {
          // Reset form fields before showing the modal
          document.getElementById("userName").value = "";
          document.getElementById("userEmail").value = "";
          document.getElementById("userPassword").value = "";
          document.getElementById("userType").selectedIndex = 0;

          // Show the modal
          addUserModal.classList.remove("hidden");
        });

        closeUserModal.addEventListener("click", function () {
          addUserModal.classList.add("hidden");
        });

        cancelUserBtn.addEventListener("click", function () {
          addUserModal.classList.add("hidden");
        });

        addUserForm.addEventListener("submit", function (e) {
          e.preventDefault();
          console.log("Formul√°rio submetido");

          // Verificar todos os elementos do formul√°rio
          const userNameInput = document.getElementById("userName");
          const userEmailInput = document.getElementById("userEmail");
          const userPasswordInput = document.getElementById("userPassword");
          const userTypeInput = document.getElementById("userType");

          console.log("Elementos do formul√°rio:", {
            userNameInput,
            userEmailInput,
            userPasswordInput,
            userTypeInput,
          });

          // Corrigir a captura dos valores
          const nome = userNameInput ? userNameInput.value : "Usu√°rio";
          const email = userEmailInput ? userEmailInput.value : "";
          const senha = userPasswordInput ? userPasswordInput.value : "";
          const tipo_usuario = userTypeInput ? userTypeInput.value : "";

          console.log("Valores capturados:", {
            nome,
            email,
            senha,
            tipo_usuario,
          });

          if (
            nome &&
            nome.trim() !== "" &&
            email &&
            email.trim() !== "" &&
            senha &&
            senha.trim() !== "" &&
            tipo_usuario
          ) {
            try {
              // Verificar se a fun√ß√£o getUsers existe
              if (typeof getUsers !== "function") {
                console.error(
                  "Fun√ß√£o getUsers n√£o encontrada. Verifique se o arquivo app.js est√° carregado corretamente."
                );
                alert("Erro interno: Fun√ß√£o getUsers n√£o encontrada");
                return;
              }

              // Verificar se o email j√° existe
              const users = getUsers();
              console.log("Usu√°rios existentes:", users);

              const emailExists = users.some((user) => user.email === email);

              if (emailExists) {
                showAlert(
                  "error",
                  "Erro",
                  "Este email j√° est√° em uso. Por favor, escolha outro."
                );
                return;
              }

              console.log("Chamando registerUserAPI");
              // Integra√ß√£o com a API - Enviar dados para registro
              registerUserAPI(nome, email, senha, tipo_usuario);
            } catch (error) {
              console.error("Erro ao verificar usu√°rios:", error);
              showAlert(
                "error",
                "Erro",
                "Ocorreu um erro ao verificar usu√°rios existentes: " +
                  error.message
              );
            }
          } else {
            showAlert(
              "error",
              "Erro",
              "Por favor, preencha todos os campos obrigat√≥rios."
            );
          }
        });
      });

      // Variable to store the pagination controller
      let usersPagination = null;

      // Modified function to render users list with pagination
      function renderUsersList() {
        const usersList = document.getElementById("usersList");
        const users = getUsers();

        // Se n√£o houver usu√°rios, mostrar mensagem
        if (users.length === 0) {
          usersList.innerHTML = `
                    <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                        Nenhum usu√°rio cadastrado
                    </li>`;
          document
            .getElementById("usersPaginationControls")
            .classList.add("hidden");
          return;
        }

        // Show pagination controls
        document
          .getElementById("usersPaginationControls")
          .classList.remove("hidden");

        // Initialize pagination if not already done
        if (!usersPagination) {
          initUsersPagination(users);
        } else {
          usersPagination.updateData(users);
        }
      }

      // Function to initialize pagination for users
      function initUsersPagination(users) {
        usersPagination = createPagination({
          data: users,
          itemsPerPage: 10,
          renderItemCallback: (container, user, startIndex) => {
            const li = document.createElement("li");
            li.className = "block hover:bg-gray-50";

            // Format role for display
            let roleDisplay = translateRole(user.type);
            let roleClass = "";

            if (user.type === "ADMINISTRADOR") {
              roleClass = "bg-red-100 text-red-800";
            } else if (user.type === "COORDENADOR") {
              roleClass = "bg-yellow-100 text-yellow-800";
            } else {
              roleClass = "bg-green-100 text-green-800";
            }

            li.innerHTML = `
                        <div class="flex items-center px-4 py-4 sm:px-6">
                            <div class="min-w-0 flex-1 flex items-center">
                                <div class="flex-shrink-0">
                                    <span class="h-12 w-12 rounded-full bg-indigo-100 flex items-center justify-center">
                                        <i class="fas fa-user text-indigo-600 text-lg"></i>
                                    </span>
                                </div>
                                <div class="min-w-0 flex-1 px-4">
                                    <div>
                                        <p class="text-sm font-medium text-blue-600 truncate">${user.name}</p>
                                        <p class="mt-1 text-sm text-gray-500">
                                            Email: ${user.email}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${roleClass} ml-2">
                                                ${roleDisplay}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <button class="text-indigo-600 hover:text-indigo-900 editUser" data-id="${user.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="ml-4 text-red-600 hover:text-red-900 deleteUser" data-id="${user.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;

            container.appendChild(li);
          },
          containerSelector: "#usersList",
          paginationContainerSelector: "#usersPaginationContainer",
          emptyCallback: (container) => {
            container.innerHTML = `
                        <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                            Nenhum usu√°rio cadastrado
                        </li>`;
          },
          countElements: {
            start: document.getElementById("usersStartItem"),
            end: document.getElementById("usersEndItem"),
            total: document.getElementById("usersTotalItems"),
          },
          prevBtnSelector: "#usersPrevPage",
          nextBtnSelector: "#usersNextPage",
          prevBtnMobileSelector: "#usersPrevPageMobile",
          nextBtnMobileSelector: "#usersNextPageMobile",
        });

        // Render the pagination
        usersPagination.render();

        // Add event handlers for the edit and delete buttons
        document.querySelectorAll(".editUser").forEach((button) => {
          button.addEventListener("click", function () {
            const userId = parseInt(this.getAttribute("data-id"));
            openEditUserModal(userId);
          });
        });

        document.querySelectorAll(".deleteUser").forEach((button) => {
          button.addEventListener("click", function () {
            const userId = parseInt(this.getAttribute("data-id"));
            deleteUser(userId);
          });
        });
      }

      // Helper function to translate role to display text
      function translateRole(role) {
        const roleMap = {
          ADMINISTRADOR: "Administrador",
          COORDENADOR: "Coordenador",
          PROFESSOR: "Professor",
          GESTOR: "Gestor",
          SECRETARIA: "Secretaria",
        };

        return roleMap[role] || role;
      }

      // Nova fun√ß√£o para carregar usu√°rios da API
      async function loadUsersFromAPI() {
        try {
          // Mostrar mensagem de carregamento
          const usersList = document.getElementById("usersList");
          usersList.innerHTML = `
                    <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i> Carregando usu√°rios da API...
                    </li>`;

          const response = await fetch(
            "https://sag-sag.rak8a3.easypanel.host/api/usuarios",
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          console.log(
            "Status da resposta da listagem de usu√°rios:",
            response.status
          );

          if (!response.ok) {
            throw new Error(
              `Erro ao carregar usu√°rios. Status: ${response.status}`
            );
          }

          const data = await response.json();
          console.log("Usu√°rios recebidos da API:", data);

          // Limpar usu√°rios locais existentes
          let localUsers = getUsers();
          // Manter apenas o usu√°rio admin local (id: 1) para garantir acesso
          localUsers = localUsers.filter((user) => user.id === 1);

          // Adicionar usu√°rios da API √† lista local
          if (Array.isArray(data)) {
            data.forEach((user) => {
              // Verificar se j√° existe um usu√°rio com este API ID
              const existingUser = localUsers.find((u) => u.apiId === user.id);

              if (!existingUser) {
                // Adicionar um novo usu√°rio
                localUsers.push({
                  id:
                    localUsers.length > 0
                      ? Math.max(...localUsers.map((u) => u.id)) + 1
                      : 1,
                  email: user.email,
                  password: "******", // N√£o temos a senha do usu√°rio
                  type: user.tipo_usuario || "USUARIO",
                  name: user.nome || "Usu√°rio",
                  apiId: user.id,
                });
              }
            });

            // Salvar a lista atualizada
            localStorage.setItem("users", JSON.stringify(localUsers));
          }

          // Renderizar a lista de usu√°rios
          renderUsersList();
        } catch (error) {
          console.error("Erro ao carregar usu√°rios da API:", error);

          // Mostrar mensagem de erro ao usu√°rio
          const usersList = document.getElementById("usersList");
          usersList.innerHTML = `
                    <li class="px-4 py-4 sm:px-6 text-center text-red-500">
                        Erro ao carregar usu√°rios da API. Usando dados locais.
                    </li>`;

          // Carregar dados locais como fallback
          setTimeout(() => {
            renderUsersList();
          }, 1500);
        }
      }

      // Fun√ß√£o para cadastrar usu√°rio via API
      async function registerUserAPI(nome, email, senha, tipo_usuario) {
        try {
          // Garantir que o nome √© uma string v√°lida
          const nomeValido =
            nome && typeof nome === "string" ? nome : "Usu√°rio";

          // Exibir indicador de carregamento
          const submitBtn = document.querySelector(
            '#addUserForm button[type="submit"]'
          );
          const originalBtnText = submitBtn.innerHTML;
          submitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Processando...';
          submitBtn.disabled = true;

          // Preparar payload no formato correto que a API espera
          const payload = {
            nome: nomeValido,
            email: email,
            senha: senha,
            tipo_usuario: tipo_usuario, // J√° est√° no formato correto do enum (ADMINISTRADOR, etc.)
          };

          console.log("Enviando dados para API:", payload);

          const response = await fetch(
            "https://sag-sag.rak8a3.easypanel.host/api/register",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            }
          );

          // Restaurar bot√£o
          submitBtn.innerHTML = originalBtnText;
          submitBtn.disabled = false;

          console.log("Status da resposta:", response.status);

          // Log da resposta completa para debug
          const responseText = await response.text();
          console.log("Resposta da API:", responseText);

          // Tentar converter para JSON se poss√≠vel
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (e) {
            console.log("Resposta n√£o √© um JSON v√°lido");
          }

          if (response.ok) {
            console.log("Usu√°rio registrado com sucesso:", data);

            // Adicionar o usu√°rio recebido da API √† lista local
            // Formato da resposta: { id: 0, nome: "string", email: "user@example.com", tipo_usuario: "ADMINISTRADOR" }
            const usuario = {
              email: data?.email || email,
              senha: senha, // A API n√£o retorna a senha
              tipo_usuario: data?.tipo_usuario || tipo_usuario,
              nome: data?.nome || nomeValido,
              apiId: data?.id,
            };

            addUser(
              usuario.email,
              usuario.senha,
              usuario.tipo_usuario,
              usuario.nome,
              usuario.apiId
            );

            // Atualizar a lista de usu√°rios
            renderUsersList();

            // Fechar o modal e resetar o formul√°rio
            document.getElementById("addUserModal").classList.add("hidden");
            document.getElementById("addUserForm").reset();

            // Mostrar mensagem de sucesso
            showAlert(
              "success",
              "Usu√°rio Cadastrado",
              "Usu√°rio cadastrado com sucesso!"
            );
          } else {
            const errorMessage = data
              ? data.message || "Erro ao registrar usu√°rio."
              : "Erro ao registrar usu√°rio.";
            showAlert("error", "Erro", errorMessage);
          }
        } catch (error) {
          console.error("Erro ao registrar usu√°rio:", error);
          showAlert(
            "error",
            "Erro",
            "Ocorreu um erro ao tentar registrar o usu√°rio: " + error.message
          );
        } finally {
          // Restaurar bot√£o
          const submitBtn = document.querySelector(
            '#addUserForm button[type="submit"]'
          );
          submitBtn.innerHTML = "Salvar";
          submitBtn.disabled = false;
        }
      }

      // Modificar a fun√ß√£o addUser para aceitar um ID da API
      function addUser(email, senha, tipo_usuario, nome, apiId = null) {
        let users = getUsers();
        const newId =
          apiId ||
          (users.length > 0
            ? Math.max(...users.map((user) => user.id)) + 1
            : 1);

        // Garantir que o nome √© uma string v√°lida
        const nomeValido = nome && typeof nome === "string" ? nome : "Usu√°rio";

        const newUser = {
          id: newId,
          email: email,
          password: senha,
          type: tipo_usuario,
          name: nomeValido,
          apiId: apiId,
        };

        users.push(newUser);
        localStorage.setItem("users", JSON.stringify(users));
        return newUser;
      }

      // Fun√ß√£o para excluir um usu√°rio
      function deleteUser(id) {
        // Procurar usu√°rio no armazenamento local
        let users = JSON.parse(localStorage.getItem("users"));
        const userToDelete = users.find((user) => user.id === id);

        if (!userToDelete) {
          showAlert("error", "Erro", "Usu√°rio n√£o encontrado.");
          return;
        }

        // Se o usu√°rio tiver um ID da API, tentar excluir na API primeiro
        if (userToDelete.apiId) {
          // Usar a fun√ß√£o showDeleteConfirm para pedir confirma√ß√£o
          showDeleteConfirm(
            "Confirmar exclus√£o",
            "Tem certeza que deseja excluir este usu√°rio?",
            function () {
              // Fun√ß√£o executada ao confirmar
              deleteUserAPI(userToDelete.apiId, id);
            }
          );
        } else {
          // N√£o tem ID da API, ent√£o apenas exclui localmente
          users = users.filter((user) => user.id !== id);
          localStorage.setItem("users", JSON.stringify(users));
          renderUsersList();
          showAlert("success", "Sucesso", "Usu√°rio exclu√≠do com sucesso!");
        }
      }

      // Fun√ß√£o para excluir usu√°rio na API
      async function deleteUserAPI(apiId, localId) {
        try {
          console.log(
            `Tentando excluir usu√°rio com API ID: ${apiId}, Local ID: ${localId}`
          );

          const response = await fetch(
            `https://sag-sag.rak8a3.easypanel.host/api/usuarios/${apiId}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          console.log("Status da resposta de exclus√£o:", response.status);

          // Log da resposta completa para debug
          const responseText = await response.text();
          console.log("Resposta da API (exclus√£o):", responseText);

          // Tentar converter para JSON se poss√≠vel
          let data;
          try {
            if (responseText) {
              data = JSON.parse(responseText);
            }
          } catch (e) {
            console.log("Resposta n√£o √© um JSON v√°lido");
          }

          if (response.ok) {
            // Excluir localmente ap√≥s sucesso na API
            let users = JSON.parse(localStorage.getItem("users"));
            users = users.filter((user) => user.id !== localId);
            localStorage.setItem("users", JSON.stringify(users));
            renderUsersList();
            showAlert("success", "Sucesso", "Usu√°rio exclu√≠do com sucesso!");
          } else {
            const errorMessage = data
              ? data.message || "Erro ao excluir usu√°rio."
              : "Erro ao excluir usu√°rio.";
            showAlert("error", "Erro", errorMessage);
          }
        } catch (error) {
          console.error("Erro ao excluir usu√°rio:", error);
          showAlert(
            "error",
            "Erro",
            "Ocorreu um erro ao tentar excluir o usu√°rio: " + error.message
          );
        }
      }

      // Fun√ß√£o para obter usu√°rios
      function getUsers() {
        try {
          const users = JSON.parse(localStorage.getItem("users")) || [];
          return users;
        } catch (error) {
          console.error("Erro ao obter usu√°rios:", error);
          return [];
        }
      }

      // Fun√ß√£o para mostrar o modal de sucesso
      function showSuccessModal(title, message, callback = null) {
        // Definir t√≠tulo e mensagem
        document.getElementById("successModalTitle").textContent =
          title || "Opera√ß√£o Conclu√≠da";
        document.getElementById("successModalMessage").textContent =
          message || "Opera√ß√£o realizada com sucesso!";

        // Mostrar o modal
        document.getElementById("successModal").classList.remove("hidden");

        // Configurar evento do bot√£o OK
        const okBtn = document.getElementById("successModalOkBtn");

        // Remover listeners anteriores
        const newOkBtn = okBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);

        // Adicionar novo listener
        newOkBtn.addEventListener("click", function () {
          document.getElementById("successModal").classList.add("hidden");
          if (typeof callback === "function") {
            callback();
          }
        });

        // Configurar evento do bot√£o de fechar
        const closeBtn = document.getElementById("closeSuccessModal");

        // Remover listeners anteriores
        const newCloseBtn = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

        // Adicionar novo listener
        newCloseBtn.addEventListener("click", function () {
          document.getElementById("successModal").classList.add("hidden");
          if (typeof callback === "function") {
            callback();
          }
        });
      }

      // Fun√ß√£o para abrir o modal de edi√ß√£o de usu√°rio
      function openEditUserModal(userId) {
        const users = getUsers();
        const user = users.find((u) => u.id === userId);

        if (!user) {
          showAlert("error", "Erro", "Usu√°rio n√£o encontrado!");
          return;
        }

        // Preencher o formul√°rio com os dados do usu√°rio
        document.getElementById("editUserId").value = user.id;
        document.getElementById("editUserApiId").value = user.apiId || "";
        document.getElementById("editUserName").value = user.name || "";
        document.getElementById("editUserEmail").value = user.email || "";
        document.getElementById("editUserPassword").value = ""; // Sempre vazio por seguran√ßa

        // Selecionar o tipo correto de usu√°rio
        const selectElement = document.getElementById("editUserType");

        // Verificar op√ß√µes dispon√≠veis
        for (let i = 0; i < selectElement.options.length; i++) {
          // Compara√ß√£o insens√≠vel a mai√∫sculas/min√∫sculas
          if (
            selectElement.options[i].value.toLowerCase() ===
            (user.type || "").toLowerCase()
          ) {
            selectElement.selectedIndex = i;
            break;
          }
        }

        // Mostrar o modal
        document.getElementById("editUserModal").classList.remove("hidden");
      }

      // Fun√ß√£o para atualizar usu√°rio via API
      async function updateUserAPI(
        userId,
        apiId,
        nome,
        email,
        senha,
        tipo_usuario
      ) {
        try {
          // Exibir indicador de carregamento
          const submitBtn = document.querySelector(
            '#editUserForm button[type="submit"]'
          );
          const originalBtnText = submitBtn.innerHTML;
          submitBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Processando...';
          submitBtn.disabled = true;

          // Verificar se temos o ID da API
          if (!apiId) {
            console.error("Erro: ID da API n√£o encontrado");
            showAlert(
              "error",
              "Erro",
              "N√£o foi poss√≠vel editar este usu√°rio. ID da API n√£o encontrado."
            );
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
            return;
          }

          // Preparar payload - incluindo senha apenas se fornecida
          const payload = {
            nome: nome,
            email: email,
            tipo_usuario: tipo_usuario,
          };

          // Adicionar senha ao payload apenas se foi fornecida
          if (senha && senha.trim() !== "") {
            payload.senha = senha;
          }

          console.log("Enviando dados para API:", payload);

          // Usar o endpoint correto
          const response = await fetch(
            `https://sag-sag.rak8a3.easypanel.host/api/usuarios/${apiId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            }
          );

          // Log da resposta completa
          const responseText = await response.text();
          console.log("Resposta da API (atualiza√ß√£o):", responseText);

          // Tentar converter para JSON se poss√≠vel
          let data;
          try {
            if (responseText) {
              data = JSON.parse(responseText);
            }
          } catch (e) {
            console.log("Resposta n√£o √© um JSON v√°lido");
          }

          if (response.ok) {
            // Atualizar usu√°rio no localStorage
            const users = getUsers();
            const index = users.findIndex((u) => u.id === parseInt(userId));

            if (index !== -1) {
              users[index].name = nome;
              users[index].email = email;
              users[index].type = tipo_usuario;
              // N√£o atualizar a senha local

              localStorage.setItem("users", JSON.stringify(users));
            }

            // Fechar o modal
            document.getElementById("editUserModal").classList.add("hidden");

            // Atualizar a lista de usu√°rios
            renderUsersList();

            // Mostrar mensagem de sucesso
            showAlert(
              "success",
              "Usu√°rio Atualizado",
              "Usu√°rio atualizado com sucesso!"
            );
          } else {
            const errorMessage = data
              ? data.message || "Erro ao atualizar usu√°rio."
              : "Erro ao atualizar usu√°rio.";
            showAlert("error", "Erro", errorMessage);
          }
        } catch (error) {
          console.error("Erro ao atualizar usu√°rio:", error);
          showAlert(
            "error",
            "Erro",
            "Ocorreu um erro ao tentar atualizar o usu√°rio: " + error.message
          );
        } finally {
          // Restaurar bot√£o
          const submitBtn = document.querySelector(
            '#editUserForm button[type="submit"]'
          );
          submitBtn.innerHTML = "Atualizar";
          submitBtn.disabled = false;
        }
      }
    </script>
  </body>
</html>
